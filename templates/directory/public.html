{% extends "base.html" %}

{% load l10n %}

{% block page_title %}
    Bot'INSA
{% endblock %}

{% block content %}
    <h2>
        Toutes les associations
        {% if cat or query %}
            <small class="text-muted">({{ associations.count }} selon les critères choisis)</small>
        {% endif %}
    </h2>
    <div class="row mb-4">
        <div class="col-12">
            <form action="{% if cat %}?cat={{ cat }}{% endif %}" method="get" class="form-inline">
                <label class="sr-only" for="selectCat">Catégorie</label>
                <select name="cat" id="selectCat" class="custom-select mr-2">
                    <option value="" {% if not cat %}selected{% endif %}>Catégorie...</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}"
                                {% if cat and cat|add:"0" == category.id %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                    {% endfor %}
                </select>
                <div class="input-group mr-2">
                    <input type="text"
                           name="query"
                           class="form-control"
                           placeholder="Recherche..." value="{% if query %}{{ query }}{% endif %}">
                </div>
                <button class="btn btn-primary mr-2" type="submit">
                    <i class="fa fa-search"></i> Chercher
                </button>
                <a href="?cat=&query=" class="btn btn-light form-control">
                    <i class="fa fa-ban"></i> Réinitialiser
                </a>
            </form>
        </div>
    </div>
    <div class="card-columns">
        <script type="application/javascript">
           <!--//
           const SKELETON_TYPE = {
                TEXT: 'text',
                TEXT_WITH_BADGE: 'textBadged',
                TEXT_WITH_THUMB: 'textThumbed',
                SHORT_TEXT: 'shortText'
            };

           let lastModalAssociationId = 0;

           function removeSkeleton(divId){
               $("#"+divId).removeClass("skeleton");
           }

           /* Function to generate HTML for modal in initial state
           * @param     SKELETON_TYPE   skeletonType        Type of skeleton to generate
           * @param     int             numberOfElement     Number of skeleton text or short text element
           * @param     String          titleContent        (Optional) Content of h5 element
           * @return    String                              HTML skeleton div element
           */
           function getHTMLInitialSection(skeletonType, numberOfElement, titleContent=null){
               let HTMLCode = '';

               const generateCode = (code) => {
                   for(let i=0; i<numberOfElement; i++){
                       HTMLCode = HTMLCode.concat(code);
                   }
               };

               if(titleContent){
                    HTMLCode = HTMLCode.concat('<h5>', titleContent, '</h5>');
               }

               switch(skeletonType){
                   case SKELETON_TYPE.SHORT_TEXT:
                       generateCode('<div class="skeleton skeletonShortText"></div>');
                       break;
                   case SKELETON_TYPE.TEXT:
                       generateCode('<div class="skeleton skeletonShortText"></div>');
                       break;
                   case SKELETON_TYPE.TEXT_WITH_THUMB:
                       HTMLCode = HTMLCode.concat('<div class="float-right skeleton col-3 skeletonThumb"></div>');
                       generateCode('<div class="skeleton skeletonText"></div>');
                       break;
                   case SKELETON_TYPE.TEXT_WITH_BADGE:
                       generateCode('<div class="skeleton skeletonTitle"></div>');
                       HTMLCode = HTMLCode.concat('<div class="skeleton skeletonBadge"></div>');
                       break;
                   default:
               }

               return HTMLCode;
           }

           function getHTMLTitleSection(name, acronym, category){
               const $ref = $("#modal-association-title");
               $ref.empty().append(name + ' ');
               if(acronym){
                   $ref.append('<small class="text-muted">(' + acronym + ')</small>');
               }
               $ref.append(' <span class="badge badge-pill badge-secondary">' + category.name + '</span>');
           }

           function getHTMLDescriptionSection(description, logo){
               const $ref = $("#modal-association-description");
               $ref.empty().append('<h5>Description</h5>');
               if(logo){
                   $ref.append('<img src="' + logo + '" alt="Logo" class="float-right col-3">');
               }

               if(description){
                   $ref.append('<p>' + description.replace(/\r\n/g,"<br/>") + '</p>');
               }else{
                   $ref.append('<p><em>Non défini</em></p>');
               }
           }

           function getHTMLPlaceSection(name, lat, long){
               const $ref = $("#modal-association-place");
               $ref.empty().append('<h5>Lieu</h5>');

               let contentElement = document.createElement('p');
               const $refContent = $(contentElement);

               $refContent.append('<i class="fa fa-fw fa-location-arrow"></i> ');
               if(name && lat && long){
                   $refContent.append('<a href="http://www.google.com/maps/place/' + lat + ',' + long + '">' + name + '</a>');
               }else{
                   $refContent.append('<em>Non défini</em>');
               }

               $ref.append($refContent);
           }

           function getHTMLWebsiteSection(link){
               const $ref = $("#modal-association-website");
               $ref.empty().append('<h5>Site web</h5>');

               let contentElement = document.createElement('p');
               const $refContent = $(contentElement);

               $refContent.append('<i class="fa fa-fw fa-external-link"></i> ');
               if(link){
                    $refContent.append('<a href="' + link +'">' + link + '</a>');
               }else{
                    $refContent.append('<em>Non défini</em>');
               }

               $ref.append($refContent);
           }

           function getHTMLNetworkSection(facebook, twitter){
               const $ref = $("#modal-association-network");
               $ref.empty().append('<h5>Réseaux sociaux</h5>');

               let contentElement = document.createElement('p');
               const $refContent = $(contentElement);

               $refContent.append('<i class="fa fa-fw fa-facebook-f"></i> ');
               if(facebook){
                   $refContent.append('<a href="' + facebook + '">Facebook</a><br/>');
               }else{
                   $refContent.append('<em>Non défini</em><br/>');
               }
               $refContent.append('<i class="fa fa-fw fa-twitter"></i> ');
               if(twitter){
                   $refContent.append('<a href="' + twitter + '">Twitter</a>');
               }else{
                   $refContent.append('<em>Non défini</em>');
               }

               $ref.append($refContent);
           }

           function getHTMLContactSection(mail, phone, phoneSource){
               const $ref = $("#modal-association-contact");
               $ref.empty().append('<h5>Contact</h5>');

               let contentElement = document.createElement('p');
               const $refContent = $(contentElement);

               $refContent.append('<i class="fa fa-fw fa-envelope-o"></i> ');
               if(mail){
                   $refContent.append('<a href="mailto:' + mail +'">' + mail +'</a><br>');
               }else{
                   $refContent.append('<em>Non défini</em><br>');
               }

               $refContent.append('<i class="fa fa-fw fa-phone"></i> ');
               if(phone){
                   $refContent.append('<a href="tel:' + phone +'">' + phone +'</a>');
                   if(phoneSource){
                        $refContent.append(phoneSource);
                   }
               }else{
                   $refContent.append('<em>Non défini</em>');
               }

               $ref.append($refContent);
           }

           function getHTMLHoursSection(hours){
               const $ref = $("#hours");
               $ref.empty().append('<h5>Horaires de permanences</h5>');
               if(hours && hours.length>0){
                   let listElement = document.createElement('ul');
                   listElement.className = "list-group";
                   const $refList = $(listElement);

                   hours.map((opening_hour) => {
                       $refList.append('<li class="list-group-item">' + opening_hour.day + ' de ' + opening_hour.begins_at + ' à ' + opening_hour.ends_at + '</li>');
                   });

                   $ref.append($refList);
               }else{
                   $ref.append('<em>Aucun horaire défini</em>');
               }
           }

           function getHTMLEventsSection(eventList){
               const $ref = $("#events");
               $ref.empty();
               if(eventList && eventList.length>0){
                   eventList.map((event, index) => {
                       let divRoot = document.createElement('div');
                       divRoot.className = "item";

                       let eventLink = "event-" + event.id;
                       $(divRoot).append('<a data-toggle="collapse" data-parent="#events" ' +
                                         'href="#' + eventLink + '" aria-expanded="true" aria-controls="event">' +
                                            event.name + ' (' + event.type + ')' + '</a>');

                       let divChild = document.createElement('div');
                       divChild.id = eventLink;
                       if(index === 0){
                           divChild.className = "collapse show";
                       }else{
                           divChild.className = "collapse";
                       }
                       divChild.setAttribute('role', 'tabpanel');

                       const refDivChild = $(divChild);
                       refDivChild.append('<p>' + event.description.replace(/\r\n/g,"<br/>") + '</p>');
                       refDivChild.append('<div class="row mb-2">');
                       refDivChild.find("div.row").append('<div class="col-md-6">');
                       refDivChild.find("div.col-md-6").append('<i class="fa fa-fw fa-calendar"></i> ' + event.begins_at + ' - ' + event.ends_at);
                       refDivChild.find("div.row").append('<div class="col-md-6">');
                       refDivChild.find("div.col-md-6:nth-child(2)").append('<i class="fa fa-fw fa-location-arrow"></i> ');

                       if(event.place.name && event.place.lat && event.place.long){
                           refDivChild.find("div.col-md-6:nth-child(2)").append('<a href="http://www.google.com/maps/place/' + event.place.lat + ',' + event.place.long +
                                                                        '">'+ event.place.name + '</a>');
                       }else{
                           refDivChild.find("div.col-md-6:nth-child(2)").append('<em>Non défini</em>');
                       }
                       refDivChild.append('<div class="row mb-2"><div class="col-12">');
                       refDivChild.find('div.col-12').append('<i class="fa fa-fw fa-link"></i> ');

                       if(event.website_url){
                           refDivChild.find('div.col-12').append('<a href="' + event.website_url + '">Page web</a>');
                       }else{
                           refDivChild.find('div.col-12').append('<em>Non défini</em>');
                       }
                       $(divRoot).append(divChild);
                       $ref.append(divRoot);
                   });
               }else{
                   $ref.append('<em>Aucun évènement à venir.</em>');
               }
           }

           function resetModal(){
               $("#modal-association-title").html(getHTMLInitialSection(SKELETON_TYPE.TEXT_WITH_BADGE, 1));
               $("#modal-association-description").html(getHTMLInitialSection(SKELETON_TYPE.TEXT_WITH_THUMB, 4, "Description"));
               $("#modal-association-place").html(getHTMLInitialSection(SKELETON_TYPE.SHORT_TEXT, 1, "Lieu"));
               $("#modal-association-website").html(getHTMLInitialSection(SKELETON_TYPE.SHORT_TEXT, 1, "Site web"));
               $("#modal-association-network").html(getHTMLInitialSection(SKELETON_TYPE.SHORT_TEXT, 2, "Réseaux sociaux"));
               $("#modal-association-contact").html(getHTMLInitialSection(SKELETON_TYPE.SHORT_TEXT, 2, "Contact"));
               $("#hours").html(getHTMLInitialSection(SKELETON_TYPE.SHORT_TEXT, 2, "Horaires de permanences"));
               $("#events").html(getHTMLInitialSection(SKELETON_TYPE.TEXT, 3));
           }

           function getModal(assoId){
               $.ajax({
                    url: '{% url "api-v1-directory-index" %}' + assoId + '/',
                    method: 'GET',
                    beforeSend: () => {
                        resetModal();
                    },
                    complete: () => {
                        const links = $('#assoDetails div.btn-group a');
                        for(let i=0; i<links.length; i++){
                            let url = links[i].href;
                            let idPos = url.lastIndexOf(lastModalAssociationId);
                            links[i].setAttribute('href', url.substring(0, idPos) + url.substring(idPos, url.length).replace(lastModalAssociationId,assoId));
                        }
                        lastModalAssociationId=assoId;
                        $('#assoDetails').modal('show');
                    }
               }).done( (data) => {
                   $("#modal-association-title").html(getHTMLTitleSection(data.name, data.acronym, data.category));
                   $("#modal-association-description").html(getHTMLDescriptionSection(data.description, data.logo_url));
                   $("#modal-association-website").html(getHTMLWebsiteSection(data.website_url));
                   $("#modal-association-network").html(getHTMLNetworkSection(data.facebook_url, data.twitter_url));
                   $("#modal-association-place").html(getHTMLPlaceSection(data.location.name, data.location.lat, data.location.long));
                   $("#modal-association-contact").html(getHTMLContactSection(data.contact_address, data.public_phone.phone, data.public_phone.source));

                   $("#hours").html(getHTMLHoursSection(data.opening_hours));
                   $("#events").html(getHTMLEventsSection(data.related_events));
               }).fail( (err) => {
                    $("div.modal").prepend(
                        '<div class="alert alert-danger" role="alert">\n' +
                        ' Une erreur est survenue, voici le détail : '+ (err.responseJSON) ? err.responseJSON.detail : 'erreur inattendue' +
                        '</div>');
               });
           }
           //-->
        </script>
        {% for asso in associations %}
            {% if asso.is_active %}
            <div class="card">
                {% if asso.logo_url %}
                    <div id="logo_{{ asso.id }}" class="skeleton">
                        <img class="card-img-top" src="{{ asso.logo_url }}" onload="removeSkeleton('logo_{{ asso.id }}')" alt="logo">
                    </div>
                {% endif %}
                <div class="card-body">
                    <h4 class="card-title">
                        {{ asso.name }}
                        {% if asso.acronym %}
                            <small>
                                ({{ asso.acronym }})
                            </small>
                        {% endif %}
                        <span class="badge badge-pill badge-secondary">{{ asso.category.name }}</span>
                    </h4>
                    <p class="card-text">{{ asso.current_directory_entry.description|linebreaksbr|truncatewords:42 }}</p>
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" onclick="getModal({{ asso.id }})">
                            Plus d'infos
                        </button>
                        {% if user.is_superuser or user.is_staff %}
                            <a href="{% url 'association-detail' asso.id %}" class="btn btn-light">
                                Admin
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>


    <!-- Basic modal -->
    <div class="modal fade" id="assoDetails" tabindex="-1" role="dialog"
             aria-labelledby="assoDetailsLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="modal-association-title" style="height: 100%; width: 100%;"></h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <ul class="nav nav-tabs" id="myTab" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" id="info-tab" data-toggle="tab"
                                   href="#info" role="tab"
                                   aria-controls="info" aria-expanded="true">
                                    Infos générales
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="hours-tab" data-toggle="tab"
                                   href="#hours" role="tab"
                                   aria-controls="hours">
                                    Horaires
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="events-tab" data-toggle="tab"
                                   href="#events" role="tab"
                                   aria-controls="events">
                                    Évènements
                                </a>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="info" role="tabpanel"
                                 aria-labelledby="info-tab">

                                <div class="row">
                                    <div class="col-12" id="modal-association-description"></div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6" id="modal-association-place"></div>
                                    <div class="col-md-6" id="modal-association-website"></div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6" id="modal-association-contact"></div>
                                    <div class="col-md-6" id="modal-association-network"></div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="hours" role="tabpanel"
                                 aria-labelledby="hours-tab" data-children=".item">
                            </div>
                            <div class="tab-pane fade" id="events" role="tabpanel"
                                 aria-labelledby="events-tab" data-children=".item">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div class="btn-group">
                            <a href="{% url 'association-print' 0 %}" class="btn btn-light">
                                Version imprimable
                            </a>
                            {% if user.is_superuser %}
                                <a href="{% url 'association-detail' 0 %}" class="btn btn-light">
                                    Admin
                                </a>
                            {% endif %}
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
{% endblock %}